                    wlanpoke To Do and History

To Do:

2021-03-25.01   Bug: partially functional gateway test to detect changing networks is falsely triggered causing script to stop mitigation.
					-> Caused by delayed or interrupted recovery coinciding with infrequent gateway test.
					-> The gateway test should not change the existing ip address or gateway until another valid gateway and ip address is obtained.
					-> A failed gateway test should not interrupt the periodic full recovery mechanism.

2020.09.17.05   Fnc: Test and handle ethernet cable attachment and disconnect.
					-> Reinstated. was canceled 0.7.5: radio stays on wireless even when Ethernet cable is attached unless selected from UI
					-> If the radio is configured for Ethernet, stop resetting the wireless.
					-> too bad the wireless and Ethernet adapters use the same MAC address....

2021-03-21.01   Bug: 2 complaints of the script not working every time (loses connection)
					-> The ResetQuick function requires signaling the udhcpc client to renew the ip address, which is handled by the wpa_cli program running in the background. However, in 4 of 7 radios here, wpa_cli was not running, which meant no lease renewal after reassociation, which was necessary to keep jive happy.
					-> ACTIVE, hopefully fixed in 0.7.5 or 0.7.4, wait for reports.
					-> WORKAROUND: disable quick reset with -Q 7 option, or -F 3 option.
					-> 0.7.6: default changed to 7.
					
2021-03-16.03   Bug: 'quick' web server serves out of data pages.
                    -> 'quick' server may become deprecated, although it uses less memory.

2020.09.17.10   Enh: Sanity check for configured options.
                    -> do not specify -w quick, causes rapid loop, hard to break.

2020.09.17.09   Enh: Improve CheckVal to at least reject -options as values.


History:


0.7.6 03/24/2021

2021-03-25.04   Enh: Support automatic log folder detection by uplogs.sh.
					-> done a la awstats.sh

2021-03-25.03   Fnc: Support automatic log folder detection by web pages, e.g., awstats.sh
					-> awstats.sh now derives the log folder from the wlanpoke command line, and reports the folder.
					-> it now shows the host name in the web page title.

2021-03-25.02   Fnc: Change script defaults to disable ResetQuick unless specifically configured.
					-> PINGQUICK=7  was 3. Disable when not testing.

					
0.7.5 03/24/2021


2021-03-24.03   Fnc: Add 'last resort' dhcpc lease renewal request in the case of persistent lack of valid ip or gateway
					->done
					
2021-03-24.02   Fnc: remove gratuitous dhcpc lease renewal request from ResetQuick, as it occurs before the reassociation, not after.
					-> done, and previous references to removed if down / up calls.
					
2021-03-24.02   Fnc: move wpa_cli_check to be called before every ping test, very frequently.
					-> done. check this to see when the wpa_cli quits. If before the network is lost, that's important to know.
					-> can be moved to once every 10 tests after this determination
					-> initial testing shows wpa_cli failing and now restarting, with no ping failure before or after.

2021-03-24.01   Fnc: remove unused FailedPings_getEntry
					-> done.
					
2021-03-23.01   Fnc: mitigate the lack of wpa_cli running to handle wpa_actions.
					-> new function wpa_cli_check() introduced to check that wpa_cli is running, and restart it if not.
					The function logs restarts, plus cases in which the wpa_cli pid(s) have changed.
					For now, this function is called only at the beginning of ResetQuick(). It could be called each ping test.
					If ResetQuick is disabled, the hard reset will relaunch wpa_cli anyway.
					Restarts and process ID changes and are logged locally and to the tcp logging server.
					The function does not check to see the wpa_cli mode (i.e., -B -a), nor does it check whether multiple instances are running. An enhancement may be desirable.
					The reason wpa_cli stops running is unknown, but it may have crashed. The recEvent utility shows messages stopping before a failure is detected, then resuming immediately after wpa_supplicant and wpa_client are killed, until the driver is unloaded. 
					-> The FailedPings array index after full resets, default [10], is used to store the count of times wpa_cli has been found missing and restarted.

2021-03-19.04   Bug: occasional web server hangs on RawPings access, everything else works.
					-> CXL: cannot reproduce

2021-03-17.04   Enh: FailedPings vector is hard to read.
                Add some sort of indication to FailedPings vector to identify the quick, full, quickcount, and fullcount slots.
                See the example in manual.txt
					-> HOLD: Takes 4 tests.... (if elif elif elif fi) ... too much for now.

2020.09.19.08   Enh: Support single and double quotes in log entries.
					-> HOLD: too complex for now

2020.09.17.07   Enh: Automatically determine wlan interface (wlan0, eth1, etc.).
					-> HOLD: eth1 seems hard coded in baby

2020.09.17.08   Enh: Use more robust method to determine squeezeplay radio name and LMS server ip.
					-> CXL: not causing any trouble so far.
					
2020.09.17.06   Fnc: Test and handle AP or lan outages.
					-> CXL: too hard to separate from wireless issues.
					
2020.09.17.05   Fnc: Test and handle ethernet cable attachment and disconnect.
					-> CXL: radio stays on wireless even when Ethernet cable is attached unless selected from UI

0.7.4 03/22/2021

2021-03-21.03	Bug: "sh: 169: unknown operand" message launching before network fully up.
					-> line 662 variable $IPFIRST missing quotes in comparison, fixed:
				      if [[ "$IPFIRST" == "169" ]] ; then		# 0.7.4: eliminate "sh: 169: unknown operand" error.

2021-03-22.01   Fnc: keep jive happy, particularly Settings | Advanced | Diagnostics: 
					"Check Network", "Wireless Info", and "Server Info"
                    -> The quick reset, while restoring lost connectivity, somehow was not sufficient for jive, 
                    which reported failures in the above menu selections. 
					->  get the dhcp client process ID to signal dhcp client to USR1=renew the lease and gateway
						local uPID="/var/run/udhcpc.""$IFACE"".pid" ; kill -s USR1 `cat "$uPID"`
                    -> NOT USED: Added ifconfig eth1 down ; wpa_cli reassoc ; ifconfig eth1 up to ResetQuick()

0.7.3 03/20/2021

2021-03-19.03   Fnc: rename gpl3.txt LICENSE.md to make GitHub happy.
                    -> done.

2021-03-19.02   Doc: document gs.bat and gs.sh
                    -> new "Customize gs.bat and Create gs.sh" manual.txt section

2021-03-20.01   Doc: change "github" to "GitHub"
                    -> 3 instances change in manual.txt

2021-03-19.01   Fnc: create batch file to request RawFiles. Let user adapt into a shell script.
                    -> gs.bat uses curl.

2021-03-19.01   Fnc: add "RawFiles" web service to awstats.sh to provide a failed pings summary report.
                    -> done -- returns 3 lines, could be shortened.
                    -> new "Desktop Radio Failure Summary Report" manual.txt section
                    -> new "RawFails Summary Report Analysis" manual.txt section

0.7.2 03/17/2021

2021-03-18.04   Enh: create shell script to upload logs to tftpd server.
                    -> very basic uplogs.sh created.

2020.09.29.03   Fnc: Evaluate: local log saves ping statistics on first ping fail,
                not sent to logging server, is this useful?
                    -> not so useful, really fills up the log files unnecessarily.
                    -> for now, log only the first failed ping, but not the history to save space.

2021-03-17.01   Enh: Improve the web status report, better process list, include version numbers
                    -> Initial host and version info, process list shows hierarchy, failed pings are separated

2021-03-17.02   Bug: Recovery report is not written to the log file, but is transmitted to ncat
                    -> elif [[ -r "$1" ]] ; then  # 0.7.2: was -f pass any file name, and if it can be read, cat it
                    -> Perhaps this is still not fixed...

2021-03-17.03   Enh: Separate the restart counters from the failed ping counters.
                    -> create 2 new slots after the maximum failed ping entry to hold the quick and full reset count.
                        PINGLFULL=$PINGLIST last entry  let "PINGLQUIK=PINGLFULL-1" next to last entry
                        FailedPings_inc $PINGLFULL  # don't interfere with the failed ping count.

2020.09.19.04   Fnc: Consider alternate app names to replace 'wlanpoke'.
                    -> too late now.

2021.02.23.03   Enh: new command line switches to replace the constant 'Restart Wait Seconds'
                    -> CXL, too obscure, and too many options as it is.

2020.09.29.04   Fnc: reset wireless if 169.154 auto configuration link local address continues for a period.
                    -> CXL, too rare, and beside the dhcp client should handle this, perhaps it does.

2020.09.21.04   Doc: Create new "technical notes" document(s) to document software and aid troubleshooting.
                    -> CSL: improved commenting and analysis section of manual.txt will have to do for now.

2020.09.29.02   Bug: software stops detecting disconnect after a period of time.
                    2020-09-28T22:20:28-0400 Chicken.21_063 failed 2020-09-28T22:19:47-0400 reset 2020-09-28T22:20:07-0400 up 2020-09-28T22:20:25-0400 ...
                    9/28/2020 11:10:15 PM   Disconnected    192.168.8.21    Chicken     00-04-20-2A-75-6B
                    was not detected. Similar on 4 other units at this time period.
                     - nc was hung on 2 examined units, despite the -w 3 timeout argument.
                     - Perhaps something in the logging server hung it. But it should time out regardless.
                     - nc_txNoHang() launches in background, saves PID for nc_ckHang () to later kill...
                    -> CXL, cannot reproduce. Many updates since issue arose.

2020.09.20.01   Fnc: did.sh De-identification script to de-identify logs for contribution to public bug database.
                    -> CXL. An example is shown in manual.txt

2020.09.19.02   Enh: Add Battery and uptime to capture statistics.
                    -> CXL: not relevant to connectivity loss


0.7.1 03/16/2021

2021-03-16.05   Bug: Launching wlanpoke with the web server option multiple times caused program loops.
                    -> the busybox kill command does not accept the negative PID to kill a process and its dependents. Removed the '-' from $PID
                    -> ahttpd.sh: added killall cat to the killall nc stopgap measures

2021-03-16.04   Enh: Speed up the 'slow' web server, it is too slow.
                    -> rearranged the program flow to launch a response more quickly,
                    removed some unnecessary steps. Better.

2021-03-16.02   Bug: web server does not work correctly.
                    -> not setting the current directory to the installation folder, fixed.

2021-03-16.01   Bug: instructions do not handle non-flat zip files (e.g., from github) correctly
                    -> added additional steps and a note at the top of manual.txt


0.7.0 03/15/2021

2021-03-02.01   Enh: ash http server? This works:
                    while true; do (echo -e "HTTP/1.1 200 OK\r\n\nWLAN stats:" ; iwconfig eth1 ; /lib/atheros/wmiconfig --getTargetStats ; echo -e "\n" ;  tail -n 12 /var/log/wlanerr.log) | nc -lp 8080 | grep "User-Agent"; done &
                    - Implemented 'quick' and 'slow' optional server launched from wlanpoke or command prompt, consisting of 3 scripts.

2021.02.26.01   Enh: add a statistic for number of failed pings and longest ping failure for later transmission.
                    -> New functions FailedPings_clear(), FailedPings_getAll(), and FailedPings_inc()

2021-03-11.01   Enh: try faster reset after a shorter number of failures.
                    -Q * number of pings to fail before quick reset (default $PINGQUICK, disable > $PINGRESET)

2021.02.23.02   Enh: new command line switches to assign values to variables to replace the constants 'Failure Limit'
                    -F * number of pings to fail before full reset (default $PINGRESET)

2021.02.23.01   Enh: new command line switches to assign values to variables to replace the constants 'Seconds between Tests'
                    -S * seconds to delay between ping tests (default $PINGSECS)


0.6.4 2/22/2021

2021.02.22.01   Bug: -x makes things go rather awry when my SBR loses connection and everything restarts, if you run with -x
                     - The conditionals on line 515 and 584 that test TCPLOG don't work. [[ -n TCPLOG ]] should be [[ -n "$TCPLOG" ]] two places.

                updated but not released 9/29/2020.
2020.09.29.01   Doc: restore correct ordering of log files for upload!
                     - cat $x.3 $x.2 $x.1 $x.0 $x > t.log   # was cat $x $x.0 $x.1 $x.2 $x.3
                     - Order was reversed just before release by review error.

2020.09.25.02   Doc: tcp logging solution for Windows.
                     - was done 0.6.3, 'ncat' from nmap.org, not listed.


0.6.3 9/25/2020

2020.09.24.02   Doc: Add script example for deidentification
                     - new section "Uploading Log Files"

2020.09.25.03   Enh: Always begin incidents with record separator in local log file.
                     - LogFile_save "RS" adds the record separator

2020.09.24.01   Doc: Add script example to upload local log files to desktop.
                     - new sections "Uploading Local Log Files to the Desktop" and "Log File Analysis"

2020.09.18.02   Enh: Replace ugly-looking log level conditionals with a debug echo (decho ?) function.
                     - e.g., decho 3 "Send Successful" # seems to work.

2020.09.17.02   Enh: Implement wlan restart before ping fails when Bit Rate falls below a specified threshold for a period of time.
                     - Cxl, too little too late, not effective, complexity not worth a 2 second gain.

2020.09.17.04   Enh: Implement automatic upload of local managed log to logging server when connected.
                     - Cxl, local rotated or pruned log files make this less important


0.6.2 9/23/2020

2020.09.22.03   Bug: -r option collision
                    -R )    RestartNetwork

2020.09.22.02   Bug: Repeated multiple entries into ERRLOGLAST if the nc transmission fails
                     - Use DTEND variable to write only one recovery entry to ERRLOGLAST

2020.09.22.01   Bug: Link Statistics preceeds failure incident in log file. nc log file correct.
                     This occurs because the statistics are saved immediately to the log file, but the
                     failure and reconnection report are saved only after reconnection...
                     - Split these. Save the failure report immediately to log file, reconnect saved when reconnected.


0.6.1 9/22/2020

2020.09.22.04   Doc: new "Modifying the Script" section
                    - discussion of default values, and hard-coded constants,
                    - paragraph on serial connection for development

2020.09.22.02   Doc: Fix minor help and documentation issues.
                    - several changes.

2020.09.22.01   Enh: Add version info to -h help.
                    - echo " -h   help and version ($Version)"


0.6.0 9/21/2020

2020.09.21.03   Enh: Adopt version number 0.6.0 (too many changes to 0.5.2)

0.5.2 9/21/2020

2020.09.21.02   Enh: add access point scan results to error logs, to test the theory that the wireless is loses the connection
                possibly because the connected access point is not found during a periodic scan.

2020.09.21.01   Enh: change options to match syslogd: sleep seconds to '-z' was -s, new log file size: -s, new max logs to keep: -b
                Not adopt: -n Run in foreground, -S Smaller logging output, -R HOST[:PORT] Log to IP or hostname on PORT (default PORT=514/UDP)
                -L Log locally and via network (default is network only if -R), -O FILE Log to given file (default:/var/log/messages)
                Similar: -l N  Set local log level
                -s SIZE Max size (KB) before rotate (default:50KB, 0=off)
                -b N    N rotated logs to keep (default:3, max=99, 'p'=trim )

2020.09.17.03   Enh: Implement actual local managed logging for local review with rotation.
                     - see 2020.09.21.01
                     - large change should have increased version number to 0.6.0, but did not.


0.5.1 9/19/2020

2020.09.19.10   Doc: manual.txt: ephemeral shell function pwp was pw.
2020.09.19.09   Doc: manual.txt: tcp logging server option is -t, not -l as in versions before 0.4.1.
2020.09.19.01   Enh: Add ping result to capture statistics.
                     - trimmed ping result added.
                     - needs more work.
2020.09.19.05   Enh: Consolidate large 'case' statement to fewer lines.
                     - done
2020.09.19.05   Enh: Add short version string to host name id for log parsing
                     - done e.g., "Playroom.53.051".
2020.09.19.03   Enh: Add last byte of radio's ip address to Hostname, e.g., "Playroom.53".
                     - done. IPLAST
2020.09.19.07   Fnc: Handle ip auto configuration address (e.g., 169.154) to prevent bogus gateway, etc.
                     - done. IPADDR, IPLAST
2020.09.19.06   Enh: Implement variable size circular buffer without arrays (ash)
                     - used 'eval' indirection to create separate variables to hold entries.


0.5.0 9/18/2020

2020.09.18.01   Enh: Pseudo circular buffer to hold relevant wlan performance data for inclusion into the PINGLOG for upload.
                     Trim data to just the minimum to keep size low. May need data every 1 or 2 seconds.
                     - Basic iwconfig data is collected every 2 seconds and saved in a fixed 8 slot circular buffer
                     - The buffer is saved to the file system when the link fails.
                     - The buffer is sent to the tcp logger when the link returns.
                     - New -vt testing option saves the buffer every 2x10=20 seconds, for an almost complete record.


0.4.2 9/18/2020

2020.09.18.04   Doc: Correct several "history.txt" citing the wrong install directory: /etc/wlanpoke/ was /etc/
                     Added instructions for ephemeral shell functions pw and ll
2020.09.18.03   Bug: hard coded /etc/ in
                    #if cat /etc/wlanerr.log | nc -w 3 $TCPLOG $TCPPORT     # 0.4.2: log no longer in /etc/, fails to send logs...!!!
                    if cat "$ERRLOG" | nc -w 3 $TCPLOG $TCPPORT

0.4.1 9/17/2020

2020.09.17.12   Implement logging server hello sign-on.
2020.09.17.11   Implement install package. NO, just a zip file.
2020.09.17.01   Add pid file to find and kill other instances, allowing only one instance.
                Done, let's see if it works!
o               Initial documentation and installation info.
o               Logging server option -t was -l. Log level option -l was -v. -v is available.

0.4.0 9/17/2020

o Date stamp all To Do items starting today, preface bugs with "Bug: "
o Added GPL3 license notice. Considering MIT license.
o Added -c option to show copyright and license notice.
o Added -w option to specify ping time out.
o Changed default log directory to /var/log/ from /etc/
o Added initial SLEEP variable and -w option to delay monitering.
o Added -s option to specify ping timeout, default 1 second.
o Fixed bug in CheckVal to more correctly check option arguments. Could be improved.
o Changed $LOGLEVEL comparison from string '>' to integer -gt. Should use (())?
o Appended $PINGLOG to initial ping failure log message.


0.3.10 9/16/2020

o Separated LOGDIR from log file variables to support alternate log directories.
o Added command line options to specify many hard coded parameters
o Added LOGLEVEL variable and ugly LOGLEVEL comparison code to suppress or allow unwanted chatter.
o Split out RestartNetwork function with command line option to just restart the network.


0.2.1  9/16/2020

o Added # commented statement to disable log upload to external 'nc' tcp logging server.
o Updated logging related comments.


0.2  9/16/2020

o Added version number 0.2. Version 0.1 history lost.
o Added incident log upload to external 'nc' tcp logging server.
o Added ALL CAPS shell variables to replace hard coded values.
o Added shell # comments
o Changed dhcpc start sleep delay to 5 from 10 seconds.
o Changed sleep delay after dhcpc launch from 5 to 1 seconds.
o Removed commented arithmetic assignments, leaving only 'let' function, awful.
o Get the ip of the slim server used at startup, using questionable method.
o Get the Squeezeplay Radio name to use instead of the hostname for dhcpc, using questionable method.


o First shell script.
